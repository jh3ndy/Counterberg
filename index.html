<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Days Countdown</title>
    <!-- Tailwind CSS for modern, responsive styling --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the canvas container */
        .canvas-container {
            max-width: 600px;
            width: 90%;
            margin: 0 auto;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            background-color: #f7fafc; /* Tailwind gray-50 */
            overflow: hidden;
        }
        #icebergCanvas {
            display: block;
            width: 100%;
            height: 400px; /* Fixed height for the drawing area */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 font-sans">

    <div class="text-center mb-10 w-full max-w-xl">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-900 mb-2">
            Countdown to Freedom!
        </h1>
        <p id="subtitle" class="text-gray-600 text-lg mb-6">Days of School Remaining</p>
        <div id="countdown" class="text-6xl sm:text-8xl font-black text-white p-6 rounded-xl bg-blue-600 shadow-xl transition duration-300">
            Calculating...
        </div>
    </div>

    <!-- Canvas Container for the Iceberg Visualization --><div class="canvas-container shadow-2xl">
        <canvas id="icebergCanvas"></canvas>
    </div>

    <script>
        // --- Configuration Constants ---
        const MAX_SCHOOL_DAYS = 40;
        const START_DATE_STR = '2025-11-25T00:00:00'; // First day (Day 40 remaining)
        const BREAK_START_STR = '2025-12-20T00:00:00'; // Holiday starts (Dec 20th is NOT counted)
        const BREAK_END_STR = '2026-01-06T00:00:00'; // School resumes (Jan 6th IS counted)
        
        const START_DATE = new Date(START_DATE_STR);
        const BREAK_START = new Date(BREAK_START_STR);
        const BREAK_END_EXCLUSIVE = new Date(BREAK_END_STR);
        
        /**
         * Checks if a given date is a school day based on the defined rules.
         * @param {Date} date - The date to check.
         * @returns {boolean} True if it is a school day.
         */
        function isSchoolDay(date) {
            // 1. Check Weekend (0=Sun, 6=Sat)
            const day = date.getDay();
            if (day === 0 || day === 6) {
                return false;
            }

            // 2. Check Holiday Break (Dec 20, 2025 up to Jan 5, 2026, inclusive)
            if (date >= BREAK_START && date < BREAK_END_EXCLUSIVE) {
                return false;
            }

            return true;
        }

        /**
         * Calculates the number of remaining school days up to a given date.
         * @param {Date} simulatedDate - The date to calculate up to (defaults to today).
         */
        function calculateDaysRemaining(simulatedDate = new Date()) {
            const checkDate = new Date(simulatedDate);
            // Reset time to midnight for accurate day comparison
            checkDate.setHours(0, 0, 0, 0);

            // If the date is before the start date, the full count remains
            if (checkDate < START_DATE) {
                return MAX_SCHOOL_DAYS;
            }

            let daysBeforeTarget = 0;
            let currentDate = new Date(START_DATE);

            // Iterate through every day from START_DATE up to (but not including) the target date
            while (currentDate < checkDate) {
                if (isSchoolDay(currentDate)) {
                    daysBeforeTarget++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Days remaining = Total count - Days elapsed
            const daysRemaining = Math.max(0, MAX_SCHOOL_DAYS - daysBeforeTarget);
            
            // Check for the absolute end date (Feb 13, 2026 is the 40th school day)
            const FINAL_DAY = new Date('2026-02-13T00:00:00');
            if (checkDate > FINAL_DAY && daysRemaining > 0) {
                 return 0; // Ensure count is 0 if we're past the end
            }

            return daysRemaining;
        }

        /**
         * Draws the dynamic iceberg visualization on the canvas (Reverted to simple triangular shape with shadows).
         * @param {number} daysRemaining - The current number of school days left (0 to 40).
         */
        function drawIceberg(daysRemaining) {
            const canvas = document.getElementById('icebergCanvas');
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            ctx.clearRect(0, 0, W, H);

            // Calculate progress: 0 (Day 40) to 1 (Day 0)
            const progress = (MAX_SCHOOL_DAYS - daysRemaining) / MAX_SCHOOL_DAYS;

            // --- Drawing Parameters ---
            const centerX = W / 2;
            const scale = W * 0.3; // Base scale for the iceberg size
            const waterLevel = H * 0.5;

            // Dynamic vertical shift (Iceberg rising out of the water)
            const maxRise = H * 0.15;
            // The iceberg rises out of the water as progress increases
            const verticalShift = maxRise * progress * 0.8;

            // --- 1. Draw Water and Sky ---
            // Sky/Air
            ctx.fillStyle = '#87ceeb'; // Light sky blue
            ctx.fillRect(0, 0, W, waterLevel);

            // Water (Deep Ocean)
            ctx.fillStyle = '#005f99'; // Deep ocean blue
            ctx.fillRect(0, waterLevel, W, H - waterLevel);


            // --- 2. Define Iceberg Points (Triangular and Dynamic) ---

            // Submerged base points (Shift down as iceberg rises)
            const p1 = { x: centerX - scale * 0.4, y: waterLevel + scale * 0.4 + verticalShift };
            const p2 = { x: centerX + scale * 0.4, y: waterLevel + scale * 0.5 + verticalShift };
            const p3 = { x: centerX, y: H }; // Absolute bottom point

            // Waterline connection points (used for submerged part)
            const p7 = { x: centerX - scale * 0.15, y: waterLevel };
            const p8 = { x: centerX + scale * 0.15, y: waterLevel };

            // --- Visible Part Points (More Triangular Shape) ---
            const basePeakY = waterLevel - scale * 0.8; // Higher peak

            // Peak (P4) - Stays centered, gets lower as days pass
            const p4 = {
                x: centerX,
                y: basePeakY + (waterLevel - scale * 0.2 - basePeakY) * progress // Vertical chipping
            };

            // Visible Base Width (Base of the triangle above water)
            const visibleBaseWidth = scale * 0.4; 
            
            // Left Shoulder (P6) - Forms the left corner of the triangle base
            const p6 = {
                x: centerX - visibleBaseWidth / 2 + (scale * 0.05 * progress), // Moves slightly inward
                y: waterLevel
            };

            // Right Shoulder (P5) - Forms the right corner of the triangle base
            const p5 = {
                x: centerX + visibleBaseWidth / 2 - (scale * 0.05 * progress), // Moves slightly inward
                y: waterLevel
            };


            // --- 3. Draw Iceberg Submerged Part (with shadow) ---
            
            // Shadow for the submerged portion (gives it a floating/3D lift effect)
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 0; 
            ctx.shadowOffsetY = 5; 


            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y); // Underwater base left
            ctx.lineTo(p3.x, p3.y); // Bottom point
            ctx.lineTo(p2.x, p2.y); // Underwater base right
            ctx.lineTo(p8.x, p8.y); // Water line right
            ctx.lineTo(p7.x, p7.y); // Water line left
            ctx.closePath();
            ctx.fillStyle = 'rgba(70, 130, 180, 0.7)'; // Steel blue, translucent
            ctx.fill();
            ctx.strokeStyle = '#3a668c';
            ctx.lineWidth = 2;
            ctx.stroke();

            // --- 4. Draw Iceberg Visible Part (above water, with shadow) ---
            
            // Adjust shadow for the top portion (slight side/down shadow)
            ctx.shadowOffsetX = 3;
            ctx.shadowOffsetY = 3;
            ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';


            ctx.beginPath();
            ctx.moveTo(p6.x, p6.y); // Left corner of the new triangular base (Waterline)
            ctx.lineTo(p4.x, p4.y); // Peak
            ctx.lineTo(p5.x, p5.y); // Right corner of the new triangular base (Waterline)
            ctx.closePath();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; // Brighter white for ice
            ctx.fill();
            ctx.strokeStyle = '#a0aec0'; // Lighter stroke
            ctx.stroke();
            
            // Reset shadows after drawing the main element
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;


            // --- 5. Draw Water Line Overlay ---
            // This adds a stark separation line between air and water
            ctx.beginPath();
            ctx.moveTo(0, waterLevel);
            ctx.lineTo(W, waterLevel);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 4;
            ctx.stroke();
        }

        /**
         * Parses the URL hash to check for a simulated date.
         * @returns {Date | null} The simulated Date object, or null if not found/invalid.
         */
        function getRundownDate() {
            const hash = window.location.hash.substring(1); // Remove '#'
            const params = new URLSearchParams(hash);
            const dateStr = params.get('date');

            if (dateStr) {
                try {
                    const date = new Date(dateStr);
                    // Check if the date is valid (e.g., not "Invalid Date")
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                } catch (e) {
                    console.error("Invalid date format in hash:", dateStr);
                }
            }
            return null;
        }

        /**
         * Main function to run the calculation and drawing.
         */
        function updateDisplay() {
            const simulatedDate = getRundownDate();
            
            let daysRemaining;
            let displayTitle;

            if (simulatedDate) {
                daysRemaining = calculateDaysRemaining(simulatedDate);
                // Format the simulated date for display
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = simulatedDate.toLocaleDateString(undefined, options);
                displayTitle = `Simulation for ${formattedDate}`;
            } else {
                daysRemaining = calculateDaysRemaining(new Date());
                displayTitle = `Days of School Remaining`;
            }
            
            // Update the HTML text
            document.getElementById('subtitle').textContent = displayTitle;
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = daysRemaining;
            
            // Adjust color based on remaining days
            if (daysRemaining <= 10) {
                countdownEl.classList.remove('bg-blue-600', 'bg-yellow-500');
                countdownEl.classList.add('bg-red-500');
            } else if (daysRemaining <= 20) {
                countdownEl.classList.remove('bg-blue-600', 'bg-red-500');
                countdownEl.classList.add('bg-yellow-500');
            } else {
                countdownEl.classList.remove('bg-red-500', 'bg-yellow-500');
                countdownEl.classList.add('bg-blue-600');
            }


            // Draw the iceberg
            const canvas = document.getElementById('icebergCanvas');
            // Ensure canvas size is set to the container size before drawing
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight; 
            drawIceberg(daysRemaining);
        }
        
        // --- Initialization and Event Listeners ---
        window.addEventListener('DOMContentLoaded', updateDisplay);
        window.addEventListener('resize', updateDisplay);
        // New: Listen for URL hash changes to run the simulation
        window.addEventListener('hashchange', updateDisplay);

    </script>
</body>
</html>